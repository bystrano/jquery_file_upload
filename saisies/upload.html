<input type="hidden" name="joindre_upload" value="oui" />
<input type="file" id="[(#ENV{id}|sinon{#ENV{nom}})]" name="#ENV{nom}[]" multiple
       data-url="#ENV{action}" >

<script type="text/javascript">
$(function () {

    (function charger_form_upload () {
        var input_selector = '\#[(#ENV{id}|sinon{#ENV{nom}})]',
            input = $(input_selector),
            upload_form = input.parents('form').first(),
            progressbar;

        upload_form.fileupload({
            add: function (e,data) {
                input.animateLoading();
                if ($('#progressbar').length == 0) {
                    input.after('<div id="progressbar"></div>');
                }
                progressbar = upload_form.find('#progressbar')
                    .progressbar({
                        'value': false
                    });

                data.submit();
            },
            done: function (e, data) {
                upload_form
                    .parents('.formulaire_spip')
                    .html(data.result)
                    .endLoading();
                charger_form_upload();
            },
            progressall: function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
                progressbar.progressbar('value', progress);
            }
        });
    })();
});
</script>
